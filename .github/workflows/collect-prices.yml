name: Collect Prices

on:
  schedule:
    # 경매장 - 악세 + 보석: 매시 10분 (UTC 기준) - 00시에 먼저 실행되어야 _raw 처리 가능
    - cron: '10 * * * *'
    # 거래소 - 계승 재련 재료 + 재련 재료 + 젬: 매시 15분 (UTC 기준)
    - cron: '15 * * * *'
    # 거래소 - 재련 추가 재료 + 각인서: 매시 20분 (UTC 기준)
    - cron: '20 * * * *'
  # 수동 실행도 가능
  workflow_dispatch:
    inputs:
      category:
        description: 'Category to collect (refine_succession,refine,gem / refine_additional,engraving / accessory,jewel / all)'
        required: false
        default: 'all'
      force_append_history:
        description: 'Force append yesterday to history_all.json (yes/no)'
        required: false
        default: 'no'

# 동시 실행 방지 - JSON 파일 동시 수정 충돌 방지
concurrency:
  group: collect-prices
  cancel-in-progress: false

jobs:
  collect-auction-accessory-jewel:
    # 10분: 경매장 - 악세 + 보석 (14개) - 00시에 먼저 실행되어 _raw 처리
    if: github.event.schedule == '10 * * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.category == 'accessory,jewel')
    runs-on: ubuntu-latest

    steps:
      - name: Collect auction prices (accessory + jewel)
        run: |
          response=$(curl -f -s -w "\n%{http_code}" --max-time 180 \
            -X GET "${{ secrets.SITE_URL }}/api/cron/collect-prices?category=accessory,jewel" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "X-Netlify-Background: true")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "API request failed with status $http_code"
            exit 1
          fi

  collect-market-refine-gem:
    # 15분: 거래소 - 계승 재련 재료 + 재련 재료 + 젬 (17개)
    if: github.event.schedule == '15 * * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.category == 'refine_succession,refine,gem')
    runs-on: ubuntu-latest

    steps:
      - name: Collect market prices (refine_succession + refine + gem)
        run: |
          response=$(curl -f -s -w "\n%{http_code}" --max-time 180 \
            -X GET "${{ secrets.SITE_URL }}/api/cron/collect-prices?category=refine_succession,refine,gem" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "X-Netlify-Background: true")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "API request failed with status $http_code"
            exit 1
          fi

      - name: Force append to history (if requested)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.force_append_history == 'yes'
        run: |
          echo "Forcing history append..."
          curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-prices?category=refine_succession,refine,gem" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json"

  collect-market-additional-engraving:
    # 20분: 거래소 - 재련 추가 재료 + 각인서 (22개)
    if: github.event.schedule == '20 * * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.category == 'refine_additional,engraving')
    runs-on: ubuntu-latest

    steps:
      - name: Collect market prices (refine_additional + engraving)
        run: |
          response=$(curl -f -s -w "\n%{http_code}" --max-time 180 \
            -X GET "${{ secrets.SITE_URL }}/api/cron/collect-prices?category=refine_additional,engraving" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "X-Netlify-Background: true")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -ge 400 ]; then
            echo "API request failed with status $http_code"
            exit 1
          fi

