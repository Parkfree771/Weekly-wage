name: Collect Prices

on:
  schedule:
    # 거래소 - 재련 재료 + 젬: 매시 정각 (UTC 기준)
    - cron: '0 * * * *'
    # 거래소 - 재련 추가 재료 + 각인서: 매시 5분 (UTC 기준)
    - cron: '5 * * * *'
    # 경매장 - 악세 + 보석: 매시 10분 (UTC 기준)
    - cron: '10 * * * *'
    # 캐시 예열: 날짜 변경 시간대에 3번 실행 (UTC 기준)
    # - 평일: KST 05:30, 06:30, 07:30 (경매장/거래소 갱신 후 3번 예열)
    # - 수요일: KST 10:30, 11:30 (점검 후 2번 예열)
    - cron: '30 20 * * *'     # 매일 05:30 (KST) - 경매장 갱신 직후
    - cron: '30 21 * * *'     # 매일 06:30 (KST) - 거래소 갱신 직후
    - cron: '30 22 * * *'     # 매일 07:30 (KST) - 추가 예열
    - cron: '30 1 * * 3'      # 수요일 10:30 (KST) - 점검 후
    - cron: '30 2 * * 3'      # 수요일 11:30 (KST) - 점검 후 추가
  # 수동 실행도 가능
  workflow_dispatch:
    inputs:
      category:
        description: 'Category to collect (refine,gem / refine_additional,engraving / accessory,jewel / all)'
        required: false
        default: 'all'

jobs:
  collect-market-refine-gem:
    # 정각(00분): 거래소 - 재련 재료 + 젬 (11개)
    if: github.event.schedule == '0 * * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.category == 'refine,gem')
    runs-on: ubuntu-latest

    steps:
      - name: Collect market prices (refine + gem)
        run: |
          curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-prices?category=refine,gem" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json"

  collect-market-additional-engraving:
    # 5분: 거래소 - 재련 추가 재료 + 각인서 (22개)
    if: github.event.schedule == '5 * * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.category == 'refine_additional,engraving')
    runs-on: ubuntu-latest

    steps:
      - name: Collect market prices (refine_additional + engraving)
        run: |
          curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-prices?category=refine_additional,engraving" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json"

  collect-auction-accessory-jewel:
    # 10분: 경매장 - 악세 + 보석 (14개)
    if: github.event.schedule == '10 * * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.category == 'accessory,jewel')
    runs-on: ubuntu-latest

    steps:
      - name: Collect auction prices (accessory + jewel)
        run: |
          curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-prices?category=accessory,jewel" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json"

  # 캐시 예열 Job (날짜 변경 시간대에 여러 번 실행)
  warm-cache:
    # 캐시 예열 스케줄일 때만 실행 (05:30, 06:30, 07:30, 수요일 10:30, 11:30)
    if: |
      github.event.schedule == '30 20 * * *' ||
      github.event.schedule == '30 21 * * *' ||
      github.event.schedule == '30 22 * * *' ||
      github.event.schedule == '30 1 * * 3' ||
      github.event.schedule == '30 2 * * 3' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Warm price history cache
        run: |
          echo "Starting cache warming..."

          # 주요 추적 아이템 ID 목록
          ITEMS=(
            # 재련 재료
            "66102106" "66102006" "66110225" "6861012" "66130143"
            "66111131" "66111132"

            # 젬
            "67400003" "67400004" "67400005" "67400006"
            "67400007" "67400008"

            # 각인서
            "66112543" "66112551" "66112553"
            "66112546" "66112552" "66112554"
            "66112711" "66112713" "66112712" "66112714"

            # 보석 (경매장)
            "auction_jewel_fear_8" "auction_jewel_fear_9" "auction_jewel_fear_10"
            "auction_jewel_nightmare_8" "auction_jewel_nightmare_9" "auction_jewel_nightmare_10"

            # 악세사리 (경매장) - 주요 4개만
            "auction_accessory_목걸이" "auction_accessory_귀걸이"
            "auction_accessory_반지" "auction_accessory_팔찌"
          )

          SUCCESS_COUNT=0
          FAIL_COUNT=0

          echo "Warming cache for ${#ITEMS[@]} items..."

          for item in "${ITEMS[@]}"; do
            # noCache=true로 강제 갱신 + 5분 캐시 적용
            http_code=$(curl -s -w "%{http_code}" -o /dev/null \
              "${{ secrets.SITE_URL }}/api/market/price-history/$item?days=999&noCache=true")

            if [ "$http_code" -eq 200 ]; then
              echo "✅ $item"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "❌ $item (HTTP $http_code)"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi

            # API 과부하 방지 (0.5초 대기)
            sleep 0.5
          done

          echo ""
          echo "Cache warming completed!"
          echo "Success: $SUCCESS_COUNT, Failed: $FAIL_COUNT"
