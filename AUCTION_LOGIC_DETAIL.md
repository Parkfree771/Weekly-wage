# 경매장 가격 수집 로직 상세 설명

## 📌 경매장 데이터 수집 규칙

> "경매장은 정각 +10분에 한번씩 최저가를 가져와서 저장하고"

✅ **맞습니다!** 매시 10분마다 실행 (00:10, 01:10, 02:10, ..., 05:10)

---

> "데이터가 쌓이는 만큼 계속 평균 계산해서 차트에 표시해주고"

✅ **맞습니다!** 실시간 평균 계산 (todayTemp의 prices 배열 평균)

### 예시 (11월 4일 예시)

| 시간 | 수집 가격 | todayTemp 누적 | 차트 표시 평균 |
|------|----------|---------------|--------------|
| 00:10 | 2,500,000 | [2500000] | **2,500,000** |
| 01:10 | 2,480,000 | [2500000, 2480000] | **2,490,000** |
| 02:10 | 2,520,000 | [2500000, 2480000, 2520000] | **2,500,000** |
| ... | ... | ... | ... |
| 05:10 | 2,490,000 | [2500000, 2480000, ..., 2490000] | **2,495,000** (6개 평균) |

**차트 조회 시 (getDailyPriceHistory):**
```javascript
// todayTemp에서 데이터 읽기
const prices = [2500000, 2480000, 2520000, ..., 2490000]; // 누적된 가격들
const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
// → 2,495,000 (평균) 계산해서 차트에 표시!
```

---

> "05시10분이 되면 하루 마지막 수집 후 전날 데이터를 최종 확정지어서 dailyPrices에 저장하고"

✅ **맞습니다!**

### 05:10 동작 상세 (핵심 변경!)

#### 1단계: 마지막 수집
```
11월 4일 05:10 현재 최저가: 2,490,000

11월 4일 todayTemp에 추가 (마지막, 24번째):
[2500000, 2480000, 2520000, ..., 2490000] (24개)
```

#### 2단계: 즉시 평균 계산 → 확정
```
평균 계산:
(2500000 + 2480000 + ... + 2490000) / 24 = 2,495,000

↓

dailyPrices에 확정 저장:
{
  itemId: "auction_gem_fear_10",
  date: "2025-11-04",  ← 11월 4일로 확정
  price: 2495000
}
```

---

> "06시10분부터는 새로운 날의 todayTemp에 쌓으면서 평균 계산하고"

✅ **맞습니다!**

### 06:10 새 날 시작

```
11월 5일 06:10 현재 최저가: 2,468,000

todayTemp 새로 시작:
[2468000]  ← 11월 5일 첫 데이터
```

### 06:10 이후 계속 누적

| 시간 | 수집 가격 | todayTemp (11월 5일) | 차트 평균 |
|------|----------|---------------------|----------|
| 06:10 | 2,468,000 | [2468000] | **2,468,000** |
| 07:10 | 2,470,000 | [2468000, 2470000] | **2,469,000** |
| 08:10 | 2,465,000 | [2468000, 2470000, 2465000] | **2,467,667** |
| ... | ... | ... | ... |

---

## 🔄 완전한 사이클 (11월 4일 → 11월 5일)

```
11월 4일 06:10 ~ 11월 5일 04:10
└─ todayTemp에 계속 누적 [price1, price2, ..., price23]
└─ 차트에는 실시간 평균 표시

11월 5일 05:10 ⭐⭐⭐ (핵심!)
├─ [수집] 11월 4일 todayTemp에 마지막 데이터 추가 [price24]
└─ [확정] 11월 4일 todayTemp 평균 계산 → dailyPrices 저장

11월 5일 06:10
└─ [시작] 11월 5일 todayTemp 새로 시작 [price_new1]

11월 5일 07:10 ~ 11월 6일 04:10
└─ todayTemp에 계속 누적
└─ 차트에는 실시간 평균 표시

11월 6일 05:10 ⭐⭐⭐
├─ [수집] 11월 5일 todayTemp에 마지막 데이터 추가
└─ [확정] 11월 5일 todayTemp 평균 계산 → dailyPrices 저장
```

---

## 💡 핵심 포인트 (수정됨!)

1. **실시간 평균**: todayTemp에 데이터가 쌓일 때마다 차트는 평균을 보여줌
2. **확정은 05:10**: 하루 마지막 수집 직후 전날 데이터를 평균내서 dailyPrices에 영구 저장
3. **순서가 중요**:
   - ❌ 잘못된 순서: 확정 → 수집 (05:10 데이터가 평균에 포함 안됨)
   - ✅ 올바른 순서: 수집 → 확정 (05:10 데이터가 평균에 포함됨)
4. **새로운 날 시작**: 06:10부터 새 날의 todayTemp 수집 시작
5. **수요일 특별 규칙**: 06:00~09:59 점검으로 수집 안됨 → 10:00부터 재개
   - 평일: 24개 데이터 (06:10 ~ 05:10)
   - 수요일: 20개 데이터 (10:10 ~ 05:10) - 06~09시 4회 건너뜀

---

## 🎯 수정 전후 비교

### ❌ 이전 로직 (문제 있었음):
```
05:10 - 수집만 (11월 4일 todayTemp에 추가)
06:10 - 확정(11월 4일 평균) + 수집(11월 5일 시작)
```
→ 타이밍이 애매하고 데이터 왜곡 가능성

### ✅ 수정 후 (올바른 로직):
```
05:10 - 수집(마지막) → 확정(평균 계산)
06:10 - 수집만 (11월 5일 시작)
```
→ 명확한 구분, 데이터 정확성 보장

---

## 🔧 수요일 특별 처리

### 수요일 타임라인 (점검 반영)

```
화요일 10:10 ~ 수요일 05:10
  → todayTemp 누적 (20개)
  → 06:10, 07:10, 08:10, 09:10은 수집 안함 (점검)

수요일 05:10 ⭐
  → 수집 (20번째, 마지막)
  → 확정 (20개 평균 → dailyPrices)

수요일 06:10, 07:10, 08:10, 09:10
  → API 요청 건너뜀 (점검 시간)
  → "Wednesday maintenance (06:00-09:59 KST)" 반환

수요일 10:10 ⭐ (점검 종료 후 첫 수집)
  → 거래소: 전날 평균가 확정 (Stats[1])
  → 경매장: 새 날 시작 (1번째)
  → 정상 수집 재개

수요일 11:10 ~ 목요일 05:10
  → todayTemp 누적 (24개)
```

### 수요일 데이터 개수
- **화요일 데이터 (수요일 05:10 확정)**: 20개
  - 화요일 10:10 ~ 수요일 05:10
  - 06:10, 07:10, 08:10, 09:10 건너뜀
- **수요일 데이터 (목요일 05:10 확정)**: 24개
  - 수요일 10:10 ~ 목요일 05:10
  - 정상 수집
